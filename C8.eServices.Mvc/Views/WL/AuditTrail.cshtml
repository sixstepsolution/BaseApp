
@{
    ViewBag.Title = "AuditTrail";
    Layout = "~/Views/Shared/_LayoutEkurhuleni.cshtml";
}

@*<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>*@

@*<link href="~/Content/wayleaveStyles/assets/Content/Timeline.css" rel="stylesheet" />*@
<script type="text/javascript" language="javascript">
    $(document).ready(function () {
        var userRole = '@Session["ekurhuleniUserRole"]';
        //alert(userRole);
        if (userRole ==="Admin") {
            $.fn.LoadApplicationsAlertsWithCounts("Y", userRole);
        }
        else {
            $.fn.LoadApplicationsAlertsWithCounts("N", userRole)
        }
        //Init();

        $.fn.showLoader = function () {
            var an = $("#searchKeyword").val();
            var st = $("#status").val();
            var appStDate = $("#startDate").val();
            var appEnDate = $("#endDate").val();
            if (an != "" && an != undefined)
            {
                $("#isLoading").show();
            }
            if (st != "" && st != undefined) {
                $("#isLoading").show();
            }
            if (appStDate != "" && appStDate != undefined) {
                $("#isLoading").show();
            }
            if (appEnDate != "" && appEnDate != undefined) {
                $("#isLoading").show();
            }

        }


        setTimeout(function () {
        var actionValue = '@ViewBag.applicationStatus';
        var appNo = '@ViewBag.applicationNo';
        var appStDate = '@ViewBag.appStartDate';
        var appEnDate = '@ViewBag.appEndDate';
        var appUname ='@ViewBag.appUsername';

        if (actionValue != "" && actionValue != undefined) {
            $("#status").val(actionValue);
        }
        if (appNo != "" && appNo != undefined) {
            $("#searchKeyword").val(appNo);
        }
            if (appStDate != "" && appStDate != undefined) {
                //var input = appStDate;
                //var d = new Date(input);
                //var tt = d.setMonth(d.getMonth());
                //var m = new Date(tt);
                //var yy = m.getFullYear() + "-" + ("0" + (m.getMonth() + 1)).slice(-2) + "-" + ("0" + m.getDate()).slice(-2);
                $("#startDate").val(appStDate);
        }
            if (appEnDate != "" && appEnDate != undefined) {
                //var timestamp = Date.parse(appEnDate);

                //if (isNaN(timestamp) == false) {
                //    var dd = new Date(timestamp);
                //    //var inputNew = appEnDate;
                //    //var dd = new Date(inputNew);
                //    var ttt = dd.setMonth(dd.getMonth());
                //    var mm = new Date(ttt);
                //    var yyy = mm.getFullYear() + "-" + ("0" + (mm.getMonth() + 1)).slice(-2) + "-" + ("0" + mm.getDate()).slice(-2);
                //    alert(yyy);
                $("#endDate").val(appEnDate);
                }



        if (appUname != "" && appUname != undefined) {
            $("#username").val(appUname);
        }
        }, 5000);

        $.ajax({
            url: "../WL/GetUserNames",
            type: 'GET',
            processData: false,
            contentType: false,
            //crossDomain: true,
            cache: false,
            enctype: 'multipart/form-data',
            dataType: 'json',
            //data: formData,
            success: function (data, textStatus, xhr) {
                console.log("======Username Result=========");
                console.log(data);
                //data = $.parseJSON(data);
                if (data.success) {
                    var userData = data.success;
                    $("#username").append("<option value='' selected>Make a selection</option>");
                    $("#username").append("<option value='All'>Select All</option>");
                    $.each(userData, function (index, item) {
                        var uName = item.username;// + " " + item.CONTACT_PERSON_LAST_NAME;
                        $("#username").append("<option value='" + uName + "'>" + uName + "</option>");
                    });
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                //console.log('Error in Operation');
                $('#isLoading').hide();
                $('#isLoading1').show();
                toastr.error('500 (Internal Server Error)');
            }
        });



    });
</script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
@*<script src="//code.jquery.com/jquery-1.12.4.js"></script>*@
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    $(document).ready(function () {
        $("#startDate").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'dd-mm-yy',
            onSelect: function (dateString, txtDate) {
                if (dateString != undefined && dateString != "" && dateString != null) {
                    var dt = dateString;
                    var ar = dt.split('-');
                    var test = ar[2] + "-" + ar[1] + "-" + ar[0];
                    $("#hdnStartDate").val(test);
                }
                else {
                    toastr.warning('Please select start date!', "warning", {
                        "timeOut": "30000",
                        "extendedTImeout": "50000",
                        "closeButton": true,
                    });
                }
            }
        });
        $("#endDate").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'dd-mm-yy',
            onSelect: function (dateString, txtDate) {
                if (dateString != undefined && dateString != "" && dateString != null) {
                    var dt = dateString;
                    var ar = dt.split('-');
                    var test = ar[2] + "-" + ar[1] + "-" + ar[0];
                    $("#hdnEndDate").val(test);
                    //$("#hdnToDate").val(dateString);
                }
                else {
                    toastr.warning('Please select end date!', "warning", {
                        "timeOut": "30000",
                        "extendedTImeout": "50000",
                        "closeButton": true,
                    });
                }
            }
        });
    });
</script>
<!------ Include the above in your HEAD tag ---------->
<section class="content" style="padding-right: 0;padding-top:0;margin-top:-10px!important;background-color:#fff!important">
    <div class="container">
        <div style="text-align:center!important"><h4>Audit Trail</h4></div>
        <div class="page-header" style="margin:0px!important">
            <div class="row">
                @using (Html.BeginForm("AuditTrail", "WL", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
                {
                    @Html.AntiForgeryToken()
                    <table class="table table-striped table-hover tabel-condensed" border="0"
                           style="font-size: 11px;" id="mytable">
                        <thead style="font-size:11px !important;color:#fff !important;margin-bottom: 0;">
                            <tr>
                                @*<td style="width: 15.5% !important">
                                        @if (ViewBag.applicationNo != null)
                                        {
                                            <h4 class="text-primary">@ViewBag.applicationNo</h4>
                                        }
                                    </td>*@

                                <td colspan="2" style="height: 40px !important; width: 15.5%!important">
                                    <div class="input-group" style="width: 100%;">
                                        <label style="color:#000!important;font-size:9pt!important">Application Number</label>
                                        <input class="form-control" autocomplete="off" style="border-radius: 4px" name="searchKeyword" placeholder="Application Number" id="searchKeyword">
                                    </div>
                                </td>
                                <td colspan="2" style="width:  15.5%">
                                    <div class="input-group" style="width: 100%">
                                        <label style="color:#000!important;font-size:9pt!important">Action</label>
                                        <select style="border-radius: 4px"
                                                class="form-control" name="status" id="status">
                                            <option value="" selected>Make a selection</option>
                                            <option value="All">Select All</option>
                                            <option value="Application Granted">Granted Applications</option>
                                            <option value="Application Rejected">Rejected Applications</option>
                                            <option value="Updated to Affected">Affected (All departments)</option>
                                            <option value="Updated to Not Affected">Not Affected (All departments)</option>
                                            <option value="Application Closed">Application Closed</option>
                                        </select>
                                    </div>
                                </td>
                                <td colspan="2" style="width:  15.5%">
                                    <div class="input-group" style="width: 100%">
                                        <label style="color:#000!important;font-size:9pt!important">Username</label>

                                        @*@Html.DropDownList("username", (List<SelectListItem>)ViewBag.VBUserList, "Select Username")*@
                                        @*@Html.DropDownList("VBUserList", ViewBag.VBUserList as SelectList, "Select Username", new { @class = "form-control", style = "border-radius: 4px", name = "username" })*@

                                        @*@Html.DropDownList("username",
                                            (IEnumerable<SelectListItem>)ViewBag.VBUserList,
                                            "Select Username")*@
                                        <select style="border-radius: 4px"
                                                class="form-control" name="username" id="username">
                                            @*<option value="" selected>Make a selection</option>
                                                <option value="All">Select All</option>*@
                                            @*<option value="Prasad">Prasad</option>
                                                <option value="Application Rejected">Rejected Applications</option>
                                                <option value="Updated to Affected">Affected (All departments)</option>
                                                <option value="Updated to Not Affected">Not Affected (All departments)</option>*@
                                        </select>
                                    </div>
                                </td>
                                <td colspan="2" style="height: 40px !important; width: 15.5%!important">
                                    <div class="input-group" style="width: 100%;">
                                        <label style="color:#000!important;font-size:9pt!important">Start Date</label>
                                        <input type="text" class="form-control" autocomplete="off" style="border-radius: 4px" name="startDate" id="startDate" />
                                        <input type="hidden" id="hdnStartDate" name="hdnStartDate" />
                                    </div>
                                </td>
                                <td style="height: 40px !important; width: 15.5%!important">
                                    <div class="input-group" style="width: 100%;">
                                        <label style="color:#000!important;font-size:9pt!important">End Date</label>
                                        <input type="text" class="form-control" autocomplete="off" style="border-radius: 4px" name="endDate" id="endDate" />
                                        <input type="hidden" id="hdnEndDate" name="hdnEndDate" />
                                    </div>
                                </td>
                                <td colspan="2" style="padding-top: 23px !important; height: 40px !important;width: 15.5% !important ">
                                    <button type="submit" class="btn btn-sm btn-green-custom" onclick="$.fn.showLoader()" style="color:#fff!important;height:28px!important">
                                        <i id="isLoading" class="fa fa-spinner fa-spin" style="font-size:9pt;display:none"></i>&nbsp;Search
                                    </button>
                                    <button type="reset" class="btn btn-warning" style="font-size: 12px; width: 70px;height:28px!important" tabindex="20">
                                        Clear
                                    </button>
                                </td>

                            <tr>
                        </thead>
                    </table>
                }
            </div>
        </div>

        @*@if (ViewBag.applicationList != null)
                {
                    string[] str1;

                    // Initialization of array
                    str1 = new string[2] { "", "timeline-inverted" };
                    int jj = 1;
            <ul class="timeline">
                @foreach (var app in (List<C8.eServices.Mvc.Models.WL_APPLICATIONFORM_AUDIT>)ViewBag.applicationList)
                {
                    if (jj % 2 == 0)
                    {
                        <li class="timeline-inverted">
                            <div class="timeline-badge success"><i class="glyphicon glyphicon-envelope"></i></div>
                            <div class="timeline-panel">
                                <div class="timeline-heading">
                                    <h4 class="timeline-title">@app.ACTION</h4>
                                    <p><small class="text-muted"><i class="glyphicon glyphicon-time text-primary"></i> @app.CREATED_DATE</small></p>
                                </div>
                                <div class="timeline-body">
                                    <p>@app.APPLICATION_STEP_DESCRIPTION</p>

                                </div>
                            </div>
                        </li>
                    }
                    else
                    {
                        <li>
                            <div class="timeline-badge warning"><i class="glyphicon glyphicon-check"></i></div>
                            <div class="timeline-panel">
                                <div class="timeline-heading">
                                    <h4 class="timeline-title">@app.ACTION</h4>
                                    <p><small class="text-muted"><i class="glyphicon glyphicon-time text-primary"></i> @app.CREATED_DATE</small></p>
                                </div>
                                <div class="timeline-body">
                                    <p>@app.APPLICATION_STEP_DESCRIPTION</p>
                                </div>
                            </div>
                        </li>
                    }

                    jj++;

                }
            </ul>
                        }*@

        @if (ViewBag.applicationList != null)
        {
            int jj = 1;
            <table class="table table-bordered table-hover" style="font-size:10pt!important">
                <tr style="background:#00A65A!important;color:#fff!important">
                    <th>S.No</th>
                    <th>Application No</th>
                    <th>Action</th>
                    <th>Outcome</th>
                    <th>Application Status</th>
                    <th>Username</th>
                    <th>Created On</th>
                    <th>Device IP Address</th>
                </tr>
                @foreach (var app in (List<C8.eServices.Mvc.Models.WL_APPLICATIONFORM_AUDIT>)ViewBag.applicationList)
                {
                    <tr>
                        <td>@jj</td>
                        <td>@app.APPLICATION_NUMBER</td>
                        <td>@app.ACTION</td>
                        <td>@app.OUTCOME</td>
                        <td>@app.APPLICATION_STEP_DESCRIPTION</td>
                        <td>@app.CREATED_USER</td>
                        <td>@app.CREATED_DATE</td>
                        <td>@app.BASEAPP_IP_ADDRESS</td>
                    </tr>
                    jj++;
                }

            </table>
        }

        @if (ViewBag.errorStatus != null)
        {
            <div style="text-align:center!important;padding-top:10px!important"><b class="text-red">@ViewBag.errorStatus</b></div>
        }

    </div>
</section>
